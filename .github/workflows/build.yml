name: Build pg_lineagelens

on:
  push:
    # Only run on version tags and main branch
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

# Add permissions needed for release creation
permissions:
  contents: write
  packages: write
  deployments: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'
      
      - name: Get version
        id: get_version
        run: |
          # If this is a tag, use the tag name without the 'v' prefix
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # Otherwise use the version from _version.py with SNAPSHOT suffix
            VERSION=$(python -c "import sys; sys.path.append('app'); from _version import __version__; print(f'{__version__}-SNAPSHOT')")
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"
      
      - name: Install pipenv
        run: |
          python -m pip install --upgrade pip
          pip install pipenv
      
      - name: Create icon file
        run: |
          mkdir -p packaging/macos
          echo "Creating placeholder icon file"
          # Create a blank icon file
          touch packaging/macos/pg_lineage.icns
      
      - name: Install dependencies
        run: |
          pipenv install --pre
          pipenv install --dev --pre
      
      - name: Build macOS app
        run: |
          # Modify PyInstaller spec file to not fail on missing icon
          sed -i.bak "s/icon=icon_file/icon=None/g" pyinstaller.spec
          sed -i.bak "s/icon='packaging\/macos\/pg_lineage.icns'/icon=None/g" pyinstaller.spec
          # Update app name in spec file
          sed -i.bak "s/name='PostgreSQL Data Lineage.app'/name='pg_lineagelens.app'/g" pyinstaller.spec
          pipenv run pyinstaller pyinstaller.spec
          bash packaging/macos/create_app.sh
          # List files in dist directory
          echo "Files in dist directory before renaming:"
          ls -la dist/
          # Rename the dmg file to match naming convention (handle glob expansion)
          FOUND_DMG=$(find dist -name "PostgreSQL*.dmg" -o -name "*.dmg" | head -n 1)
          if [ -n "$FOUND_DMG" ]; then
            echo "Found DMG file: $FOUND_DMG"
            mv "$FOUND_DMG" dist/pg_lineagelens-${{ steps.get_version.outputs.version }}-macos.dmg
            echo "Renamed to: dist/pg_lineagelens-${{ steps.get_version.outputs.version }}-macos.dmg"
          else
            echo "No DMG file found in dist directory"
            ls -R dist/
          fi
          # Verify final result
          echo "Final files in dist directory:"
          ls -la dist/
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: |
            dist/pg_lineagelens-*.dmg
            dist/*.dmg
          if-no-files-found: error
          retention-days: 7
  
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'
          
      - name: Get version
        id: get_version
        run: |
          # If this is a tag, use the tag name without the 'v' prefix
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # Otherwise use the version from _version.py with SNAPSHOT suffix
            VERSION=$(python -c "import sys; sys.path.append('app'); from _version import __version__; print(f'{__version__}-SNAPSHOT')")
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"
      
      - name: Install pipenv
        run: |
          python -m pip install --upgrade pip
          pip install pipenv
      
      - name: Create icon file
        run: |
          mkdir -p packaging/linux
          # Create a blank PNG file
          touch packaging/linux/pg_lineage.png
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev
          pipenv install --pre
          pipenv install --dev --pre
      
      - name: Build Linux package
        run: |
          # Update app name in spec file
          sed -i.bak "s/name='PostgreSQL Data Lineage.app'/name='pg_lineagelens.app'/g" pyinstaller.spec || true
          pipenv run pyinstaller pyinstaller.spec
          chmod +x packaging/linux/create_package.sh
          packaging/linux/create_package.sh
          # List files in dist directory
          echo "Files in dist directory before renaming:"
          ls -la dist/
          # Rename the tar.gz file to match naming convention (handle glob expansion)
          FOUND_TARGZ=$(find dist -name "PostgreSQL*.tar.gz" -o -name "*.tar.gz" | head -n 1)
          if [ -n "$FOUND_TARGZ" ]; then
            echo "Found TAR.GZ file: $FOUND_TARGZ"
            mv "$FOUND_TARGZ" dist/pg_lineagelens-${{ steps.get_version.outputs.version }}-linux.tar.gz
            echo "Renamed to: dist/pg_lineagelens-${{ steps.get_version.outputs.version }}-linux.tar.gz"
          else
            echo "No TAR.GZ file found in dist directory"
            ls -R dist/
          fi
          # Verify final result
          echo "Final files in dist directory:"
          ls -la dist/
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-package
          path: |
            dist/pg_lineagelens-*.tar.gz
            dist/*.tar.gz
          if-no-files-found: error
          retention-days: 7
  
# Windows build disabled for now
#  build-windows:
#    runs-on: windows-latest
#    steps:
#      - uses: actions/checkout@v4
#      
#      - name: Set up Python
#        uses: actions/setup-python@v5
#        with:
#          python-version: '3.8'
#      
#      - name: Get version
#        id: get_version
#        shell: bash
#        run: |
#          # If this is a tag, use the tag name without the 'v' prefix
#          if [[ $GITHUB_REF == refs/tags/v* ]]; then
#            VERSION=${GITHUB_REF#refs/tags/v}
#          else
#            # Otherwise use the version from _version.py with SNAPSHOT suffix
#            VERSION=$(python -c "import sys; sys.path.append('app'); from _version import __version__; print(f'{__version__}-SNAPSHOT')")
#          fi
#          echo "version=$VERSION" >> $GITHUB_OUTPUT
#          echo "Building version: $VERSION"
#      
#      - name: Install pipenv
#        run: |
#          python -m pip install --upgrade pip
#          pip install pipenv
#      
#      - name: Create icon files
#        run: |
#          New-Item -Path packaging/windows -ItemType Directory -Force
#          New-Item -ItemType File -Path "packaging/windows/pg_lineage.ico" -Force
#          New-Item -ItemType File -Path "packaging/windows/installer-sidebar.bmp" -Force
#          New-Item -ItemType File -Path "packaging/windows/installer-header.bmp" -Force
#        shell: pwsh
#      
#      - name: Install NSIS
#        run: |
#          choco install nsis -y
#        shell: pwsh
#      
#      - name: Install dependencies
#        run: |
#          pipenv install --pre
#          pipenv install --dev --pre
#      
#      - name: Build Windows package
#        run: |
#          # Update app name in spec file
#          sed -i.bak "s/name='PostgreSQL Data Lineage.app'/name='pg_lineagelens.app'/g" pyinstaller.spec
#          pipenv run pyinstaller pyinstaller.spec
#          Compress-Archive -Path "dist/pg_lineage/*" -DestinationPath "dist/pg_lineagelens-${{ steps.get_version.outputs.version }}-windows.zip"
#          & 'C:\Program Files (x86)\NSIS\makensis.exe' packaging/windows/installer.nsi
#          Move-Item pg_lineage_setup.exe "dist/pg_lineagelens-${{ steps.get_version.outputs.version }}-setup.exe"
#        shell: pwsh
#      
#      - name: Upload Windows artifacts
#        uses: actions/upload-artifact@v4
#        with:
#          name: windows-package
#          path: |
#            dist/pg_lineagelens-*.zip
#            dist/pg_lineagelens-*-setup.exe
#          if-no-files-found: error
  
  create-release:
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find . -type f -name "*.dmg" -o -name "*.tar.gz"
          
      - name: Debug artifact paths
        run: |
          # Make directory structure easier to see
          ls -la macos-app/ || echo "No macos-app directory"
          ls -la linux-package/ || echo "No linux-package directory"
          # Check for artifacts anywhere
          find . -type f -name "*.dmg" -o -name "*.tar.gz"
        
      - name: Get version
        id: get_version
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Creating release for version: $VERSION"
          
      - name: Copy artifacts to release directory
        run: |
          mkdir -p release_files
          # Try to find and copy artifacts regardless of directory structure
          find . -type f -name "*.dmg" -exec cp {} release_files/ \;
          find . -type f -name "*.tar.gz" -exec cp {} release_files/ \;
          echo "Files ready for release:"
          ls -la release_files/
        
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tag_name: ${{ github.ref }}
          release_name: "pg_lineagelens v${{ steps.get_version.outputs.version }}"
          body: |
            # pg_lineagelens v${{ steps.get_version.outputs.version }}
            
            ## Binaries
            - macOS: pg_lineagelens-${{ steps.get_version.outputs.version }}-macos.dmg
            - Linux: pg_lineagelens-${{ steps.get_version.outputs.version }}-linux.tar.gz
            
            ## Installation
            Download the appropriate binary for your platform and run it.
            
            ## Notes
            See CHANGELOG.md for details on changes in this release.
          draft: true
          prerelease: false
          
      - name: Find macOS DMG
        id: find_macos
        run: |
          DMG_PATH=$(find . -name "*.dmg" | head -n 1)
          if [ -n "$DMG_PATH" ]; then
            echo "Found DMG: $DMG_PATH"
            echo "dmg_path=$DMG_PATH" >> "$GITHUB_OUTPUT"
          else
            echo "No DMG file found"
            find . -type f
          fi
          
      - name: Find Linux tarball
        id: find_linux
        run: |
          TARBALL_PATH=$(find . -name "*.tar.gz" | head -n 1)
          if [ -n "$TARBALL_PATH" ]; then
            echo "Found tarball: $TARBALL_PATH"
            echo "tarball_path=$TARBALL_PATH" >> "$GITHUB_OUTPUT"
          else
            echo "No tarball found"
            find . -type f
          fi
          
      - name: Upload macOS DMG
        if: steps.find_macos.outputs.dmg_path != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_macos.outputs.dmg_path }}
          asset_name: pg_lineagelens-${{ steps.get_version.outputs.version }}-macos.dmg
          asset_content_type: application/octet-stream
          
      - name: Upload Linux tarball
        if: steps.find_linux.outputs.tarball_path != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_linux.outputs.tarball_path }}
          asset_name: pg_lineagelens-${{ steps.get_version.outputs.version }}-linux.tar.gz
          asset_content_type: application/gzip